apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"batch/v1","kind":"CronJob","metadata":{"annotations":{},"name":"grafana-token-updater","namespace":"grafana"},"spec":{"jobTemplate":{"spec":{"template":{"spec":{"containers":[{"command":["/bin/sh","-c","# 創建新的 token\nNEW_TOKEN=\"Bearer $(oc create token grafana-token-updater -n grafana)\"\noc whoami\n"],"image":"docker.io/juouyang/grafana-tools:1.0.0","name":"token-updater"}],"restartPolicy":"OnFailure","serviceAccountName":"grafana-token-updater"}}}},"schedule":"0 */1 * * *"}}
  creationTimestamp: "2024-08-27T03:34:48Z"
  generation: 11
  name: grafana-token-updater
  namespace: grafana
  resourceVersion: "73993112"
  uid: 62dc6336-081b-4da9-8ef9-7b917e4e2cba
spec:
  concurrencyPolicy: Replace
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      creationTimestamp: null
    spec:
      template:
        metadata:
          creationTimestamp: null
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - |
              # 創建新的 token
              NEW_TOKEN="Bearer $(oc create token grafana-dev-sa -n grafana)"
              echo $NEW_TOKEN
              oc whoami
              # 更新 GrafanaDatasource
              oc get grafanadatasource grafanadatasource-dev -n grafana -o yaml | \
                yq e '.spec.secureJsonData.httpHeaderValue1 = $NEW_TOKEN' - | \
                oc apply -f -
            image: docker.io/juouyang/grafana-tools:1.0.0
            imagePullPolicy: IfNotPresent
            name: token-updater
            resources: {}
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
          dnsPolicy: ClusterFirst
          restartPolicy: Never
          schedulerName: default-scheduler
          securityContext: {}
          serviceAccount: grafana-token-updater
          serviceAccountName: grafana-token-updater
          terminationGracePeriodSeconds: 30
  schedule: 0 * * * *
  successfulJobsHistoryLimit: 1
  suspend: false
status:
  lastScheduleTime: "2024-08-27T03:55:00Z"
  lastSuccessfulTime: "2024-08-27T03:55:08Z"
